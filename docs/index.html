<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­éº»å°‡è¨˜å¸³ç³»çµ± (ç´”è‡ªè¨‚ç©å®¶)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .recording { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 p-4 md:p-8 max-w-2xl mx-auto">

    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-red-600 mb-2">ğŸ€„ å°ˆæ¥­éº»å°‡è¨˜å¸³ç³»çµ±</h1>
        <p class="text-sm text-slate-500">è‡ªè¨‚åº•å°èˆ‡ç´”æ‰‹å‹•ç©å®¶åå–®</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <section class="bg-white rounded-xl shadow-sm p-5 border border-slate-100">
            <h2 class="text-lg font-bold mb-4 flex items-center">âš™ï¸ ç‰Œå±€è¨­å®š</h2>
            <div class="flex gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-slate-700 mb-1">åº•</label>
                    <input type="number" id="baseAmount" value="30" min="0" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" onchange="updateSettings()">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-slate-700 mb-1">ä¸€å°</label>
                    <input type="number" id="pointAmount" value="10" min="0" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" onchange="updateSettings()">
                </div>
            </div>
            <p class="text-xs text-slate-500 mt-2 text-center" id="settingDisplay">ç›®å‰è¨­å®šï¼š30 åº• / 10 å°</p>
        </section>

        <section class="bg-white rounded-xl shadow-sm p-5 border border-slate-100">
            <h2 class="text-lg font-bold mb-4 flex items-center">ğŸ‘¥ æ–°å¢ç©å®¶</h2>
            <div class="flex gap-2">
                <input type="text" id="newPlayerName" placeholder="è¼¸å…¥ç©å®¶å§“å..." class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" onkeypress="handleKeyPress(event)">
                <button onclick="addPlayer()" class="bg-slate-800 text-white px-3 py-2 rounded-lg font-medium hover:bg-slate-700 transition">æ–°å¢</button>
            </div>
            <p class="text-xs text-slate-500 mt-2">è«‹æ–°å¢ç©å®¶ä¸¦åœ¨ä¸‹æ–¹å‹¾é¸ 4 ä½ä¸Šå ´</p>
        </section>
    </div>

    <section class="bg-white rounded-xl shadow-sm p-5 mb-6 border border-slate-100">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold flex items-center">ğŸ‘‘ ç›®å‰ç©å®¶</h2>
            <span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-md font-medium">è«‹å‹¾é¸ä¸Šå ´ç©å®¶ (æœ€å¤š4äºº)</span>
        </div>
        <div id="playersGrid" class="grid grid-cols-2 md:grid-cols-4 gap-3">
            </div>
    </section>

    <section class="bg-white rounded-xl shadow-sm p-5 mb-6 border border-slate-100">
        <h2 class="text-lg font-bold mb-4">ğŸ“ è¨˜å¸³é¢æ¿</h2>
        
        <div class="mb-6 p-4 bg-red-50 rounded-lg text-center">
            <button id="voiceBtn" onclick="toggleVoice()" class="bg-red-500 text-white w-16 h-16 rounded-full text-2xl shadow-lg hover:bg-red-600 transition flex items-center justify-center mx-auto mb-3 btn-disabled" disabled>
                ğŸ™ï¸
            </button>
            <p id="voiceStatus" class="text-sm text-red-700 font-medium">è«‹å…ˆå‹¾é¸ä¸Šå ´ç©å®¶å¾Œå•Ÿç”¨</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
            <div class="col-span-1 md:col-span-1">
                <label class="block text-sm font-medium text-slate-700 mb-1">è´å®¶ (èƒ¡/è‡ªæ‘¸)</label>
                <select id="winnerSelect" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 bg-slate-50" disabled></select>
            </div>
            <div class="col-span-1 md:col-span-1">
                <label class="block text-sm font-medium text-slate-700 mb-1">è¼¸å®¶ (æ”¾æ§)</label>
                <select id="loserSelect" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 bg-slate-50" disabled></select>
            </div>
            <div class="col-span-1 md:col-span-1">
                <label class="block text-sm font-medium text-slate-700 mb-1">è´äº†å¹¾å°ï¼Ÿ</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="taiInput" min="0" value="1" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" oninput="calculatePreview()">
                    <span class="text-sm text-slate-600">å°</span>
                </div>
            </div>
            <div class="col-span-1 md:col-span-1 text-right md:text-center pb-2">
                <span class="text-xs text-slate-500 block">å–®å®¶æ‡‰ä»˜é‡‘é¡</span>
                <span id="previewAmount" class="text-xl font-bold text-red-600">40</span>
            </div>
        </div>
        <button id="recordBtn" onclick="manualRecord()" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition btn-disabled" disabled>ç¢ºèªè¨˜å¸³</button>
    </section>

    <section class="bg-white rounded-xl shadow-sm p-5 border border-slate-100">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold">ğŸ“œ äº¤æ˜“ç´€éŒ„</h2>
            <button onclick="clearHistory()" class="text-sm text-slate-400 hover:text-red-500 transition">æ¸…ç©ºç´€éŒ„</button>
        </div>
        <ul id="historyLog" class="space-y-2 max-h-60 overflow-y-auto pr-2">
            <li class="text-slate-400 text-sm text-center py-4">ç›®å‰å°šç„¡ç´€éŒ„</li>
        </ul>
    </section>

    <script>
        // åˆå§‹åŒ–ï¼šå„ªå…ˆå¾ localStorage è®€å–è³‡æ–™
        let players = JSON.parse(localStorage.getItem('mahjong_players')) || [];
        let activePlayerIds = JSON.parse(localStorage.getItem('mahjong_active_players')) || [];
        let history = JSON.parse(localStorage.getItem('mahjong_history')) || [];
        let baseAmount = parseInt(localStorage.getItem('mahjong_base')) || 30;
        let pointAmount = parseInt(localStorage.getItem('mahjong_point')) || 10;

        document.getElementById('baseAmount').value = baseAmount;
        document.getElementById('pointAmount').value = pointAmount;

        function saveData() {
            localStorage.setItem('mahjong_players', JSON.stringify(players));
            localStorage.setItem('mahjong_active_players', JSON.stringify(activePlayerIds));
            localStorage.setItem('mahjong_history', JSON.stringify(history));
            localStorage.setItem('mahjong_base', baseAmount);
            localStorage.setItem('mahjong_point', pointAmount);
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                isRecording = true;
                const btn = document.getElementById('voiceBtn');
                btn.classList.add('recording');
                document.getElementById('voiceStatus').innerText = "è†è½ä¸­... è«‹èªªè©± (ä¾‹å¦‚ï¼šå°æ˜è‡ªæ‘¸å…©å°)";
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('voiceStatus').innerText = `è¾¨è­˜çµæœï¼šã€Œ${transcript}ã€`;
                processVoiceCommand(transcript);
            };

            recognition.onerror = function(event) {
                document.getElementById('voiceStatus').innerText = "èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼Œè«‹é‡è©¦æˆ–æ‰‹å‹•è¼¸å…¥ã€‚";
                stopVoiceUI();
            };

            recognition.onend = function() {
                stopVoiceUI();
            };
        }

        function toggleVoice() {
            if (!recognition || activePlayerIds.length < 2) return;
            if (isRecording) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function stopVoiceUI() {
            isRecording = false;
            document.getElementById('voiceBtn').classList.remove('recording');
            setTimeout(() => {
                if(!isRecording && activePlayerIds.length >= 2) {
                    document.getElementById('voiceStatus').innerText = "é»æ“Šéº¥å…‹é¢¨é–‹å§‹èªéŸ³è¨˜å¸³";
                }
            }, 4000);
        }

        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function updateSettings() {
            baseAmount = parseInt(document.getElementById('baseAmount').value) || 0;
            pointAmount = parseInt(document.getElementById('pointAmount').value) || 0;
            document.getElementById('settingDisplay').innerText = `ç›®å‰è¨­å®šï¼š${baseAmount} åº• / ${pointAmount} å°`;
            calculatePreview();
            saveData(); 
        }

        function calculatePreview() {
            const tais = parseInt(document.getElementById('taiInput').value) || 0;
            const total = baseAmount + (pointAmount * tais);
            document.getElementById('previewAmount').innerText = total;
            return total;
        }

        function toggleActivePlayer(id) {
            if (activePlayerIds.includes(id)) {
                activePlayerIds = activePlayerIds.filter(pid => pid !== id);
            } else {
                if (activePlayerIds.length >= 4) {
                    alert("æœ€å¤šåªèƒ½å‹¾é¸ 4 ä½ä¸Šå ´ç©å®¶ï¼");
                    renderPlayers(); // åˆ·æ–°ä»¥é‡ç½® UI å‹¾é¸ç‹€æ…‹
                    return;
                }
                activePlayerIds.push(id);
            }
            saveData();
            renderPlayers();
        }

        function updateUIState() {
            const isReady = activePlayerIds.length >= 2;
            const winnerSelect = document.getElementById('winnerSelect');
            const loserSelect = document.getElementById('loserSelect');
            const recordBtn = document.getElementById('recordBtn');
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceStatus = document.getElementById('voiceStatus');

            winnerSelect.disabled = !isReady;
            loserSelect.disabled = !isReady;
            recordBtn.disabled = !isReady;
            
            if (isReady) {
                winnerSelect.classList.remove('bg-slate-50');
                loserSelect.classList.remove('bg-slate-50');
                recordBtn.classList.remove('btn-disabled');
                
                if (SpeechRecognition) {
                    voiceBtn.disabled = false;
                    voiceBtn.classList.remove('btn-disabled', 'opacity-50', 'cursor-not-allowed');
                    voiceStatus.innerText = "é»æ“Šéº¥å…‹é¢¨é–‹å§‹èªéŸ³è¨˜å¸³";
                }
            } else {
                winnerSelect.classList.add('bg-slate-50');
                loserSelect.classList.add('bg-slate-50');
                recordBtn.classList.add('btn-disabled');
                voiceBtn.disabled = true;
                voiceBtn.classList.add('btn-disabled');
                voiceStatus.innerText = "è«‹å…ˆå‹¾é¸è‡³å°‘å…©åä¸Šå ´ç©å®¶";
            }
        }

        function renderPlayers() {
            const grid = document.getElementById('playersGrid');
            const winnerSelect = document.getElementById('winnerSelect');
            const loserSelect = document.getElementById('loserSelect');
            
            const currentWinner = winnerSelect.value;
            const currentLoser = loserSelect.value;

            grid.innerHTML = '';
            
            if (players.length === 0) {
                grid.innerHTML = '<div class="col-span-2 md:col-span-4 text-center text-slate-400 py-6 border-2 border-dashed border-slate-200 rounded-lg">å°šæœªåŠ å…¥ä»»ä½•ç©å®¶</div>';
                winnerSelect.innerHTML = '<option value="">è«‹å…ˆæ–°å¢</option>';
                loserSelect.innerHTML = '<option value="">è«‹å…ˆæ–°å¢</option>';
            } else {
                // ç”Ÿæˆç©å®¶å¡ç‰‡ (åŒ…å«å‹¾é¸æ¡†)
                players.forEach(p => {
                    const isActive = activePlayerIds.includes(p.id);
                    grid.innerHTML += `
                        <div class="bg-slate-50 p-3 rounded-lg border text-center relative group transition-all ${isActive ? 'ring-2 ring-red-500 bg-red-50/30' : ''}">
                            <input type="checkbox" class="absolute top-2 left-2 w-4 h-4 cursor-pointer accent-red-600" onchange="toggleActivePlayer('${p.id}')" ${isActive ? 'checked' : ''} title="å‹¾é¸ä¸Šå ´">
                            <button onclick="removePlayer('${p.id}')" class="absolute -top-2 -right-2 bg-red-100 text-red-600 rounded-full w-6 h-6 text-xs hidden group-hover:block hover:bg-red-200 shadow-sm z-10">âœ•</button>
                            <div class="font-bold text-slate-700 truncate mt-1" title="${p.name}">${p.name}</div>
                            <div class="text-xl font-bold mt-1 ${p.score >= 0 ? 'text-green-600' : 'text-red-600'}">${p.score}</div>
                        </div>
                    `;
                });

                // åªå°‡ã€Œä¸Šå ´ç©å®¶ã€åŠ å…¥é¸å–®
                const activePlayersList = players.filter(p => activePlayerIds.includes(p.id));
                
                if (activePlayersList.length === 0) {
                    winnerSelect.innerHTML = '<option value="">è«‹å‹¾é¸ä¸Šå ´ç©å®¶</option>';
                    loserSelect.innerHTML = '<option value="">è«‹å‹¾é¸ä¸Šå ´ç©å®¶</option>';
                } else {
                    winnerSelect.innerHTML = '';
                    loserSelect.innerHTML = '<option value="all">ä¸€å®¶è´ï¼Œå…¶é¤˜å…¨è¼¸ (è‡ªæ‘¸)</option>';
                    activePlayersList.forEach(p => {
                        winnerSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                        loserSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }

                if (currentWinner && activePlayersList.find(p => p.id === currentWinner)) winnerSelect.value = currentWinner;
                if (currentLoser && (currentLoser === 'all' || activePlayersList.find(p => p.id === currentLoser))) loserSelect.value = currentLoser;
            }

            updateUIState();
        }

        function renderHistory() {
            const logUl = document.getElementById('historyLog');
            if (history.length === 0) {
                logUl.innerHTML = '<li class="text-slate-400 text-sm text-center py-4">ç›®å‰å°šç„¡ç´€éŒ„</li>';
                return;
            }
            logUl.innerHTML = history.map(h => `
                <li class="bg-slate-50 p-3 rounded-lg border text-sm text-slate-700 flex justify-between items-center">
                    <span>${h.text}</span>
                    <span class="text-xs text-slate-400">${h.time}</span>
                </li>
            `).join('');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') addPlayer();
        }

        function addPlayer() {
            const input = document.getElementById('newPlayerName');
            const name = input.value.trim();
            if (!name) return;
            if (players.find(p => p.name === name)) {
                alert("ç©å®¶åç¨±å·²å­˜åœ¨ï¼");
                return;
            }
            
            const newId = generateId();
            players.push({ id: newId, name: name, score: 0 });
            
            // å¦‚æœç›®å‰ä¸Šå ´äººæ•¸ä¸åˆ° 4 äººï¼Œè‡ªå‹•å¹«æ–°ç©å®¶æ‰“å‹¾
            if (activePlayerIds.length < 4) {
                activePlayerIds.push(newId);
            }
            
            input.value = '';
            renderPlayers();
            saveData(); 
        }

        function removePlayer(id) {
            const p = players.find(x => x.id === id);
            if (p.score !== 0 && !confirm(`ç©å®¶ [${p.name}] å°šæœ‰åˆ†æ•¸ (${p.score})ï¼Œç¢ºå®šè¦ç§»é™¤å—ï¼Ÿ`)) {
                return;
            }
            players = players.filter(p => p.id !== id);
            activePlayerIds = activePlayerIds.filter(pid => pid !== id);
            renderPlayers();
            saveData(); 
        }

        function processTransaction(winnerId, loserId, tais) {
            if (activePlayerIds.length < 2) {
                alert("ä¸Šå ´äººæ•¸ä¸è¶³ï¼");
                return false;
            }
            if (isNaN(tais) || tais < 0) {
                alert("ç„¡æ•ˆçš„å°æ•¸ï¼");
                return false;
            }

            const amountPerPerson = baseAmount + (pointAmount * tais);
            const winner = players.find(p => p.id === winnerId);
            let logText = "";

            if (loserId === "all") {
                // åš´æ ¼éæ¿¾ï¼šæ‰¾å‡ºã€Œæœ‰ä¸Šå ´ã€ä¸”ã€Œä¸æ˜¯è´å®¶ã€çš„ç©å®¶ä¾†ä»˜éŒ¢
                const payingPlayers = players.filter(p => activePlayerIds.includes(p.id) && p.id !== winnerId);
                const totalWin = amountPerPerson * payingPlayers.length;
                
                winner.score += totalWin;
                payingPlayers.forEach(p => p.score -= amountPerPerson);
                logText = `ã€è‡ªæ‘¸ã€‘${winner.name} ${tais}å°ï¼Œè´å¾— ${totalWin} é» (æ¯å®¶ ${amountPerPerson})`;
            } else {
                if (winnerId === loserId) {
                    alert("è´å®¶å’Œè¼¸å®¶ä¸èƒ½æ˜¯åŒä¸€äººï¼");
                    return false;
                }
                const loser = players.find(p => p.id === loserId);
                winner.score += amountPerPerson;
                loser.score -= amountPerPerson;
                logText = `ã€æ”¾æ§ã€‘${loser.name} æ”¾æ§çµ¦ ${winner.name} ${tais}å°ï¼Œæ”¯ä»˜ ${amountPerPerson} é»`;
            }

            const time = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            history.unshift({ text: logText, time: time });
            renderPlayers();
            renderHistory();
            saveData(); 
            return true;
        }

        function manualRecord() {
            const winnerId = document.getElementById('winnerSelect').value;
            const loserId = document.getElementById('loserSelect').value;
            const tais = parseInt(document.getElementById('taiInput').value);
            
            if (processTransaction(winnerId, loserId, tais)) {
                 document.getElementById('taiInput').value = 1;
                 calculatePreview();
            }
        }

        function clearHistory() {
            if (history.length === 0) return;
            if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„ä¸¦å°‡åˆ†æ•¸æ­¸é›¶å—ï¼Ÿ")) {
                players.forEach(p => p.score = 0);
                history = [];
                renderPlayers();
                renderHistory();
                saveData(); 
            }
        }

        function processVoiceCommand(text) {
            if (activePlayerIds.length < 2) return;
            
            const numMap = { 'ä¸€': 1, 'äºŒ': 2, 'å…©': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5, 'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 10 };
            let tais = null;
            
            const numMatch = text.match(/\d+/);
            if (numMatch) {
                tais = parseInt(numMatch[0]);
            } else {
                for (let key in numMap) {
                    if (text.includes(key + "å°") || text.includes(key + "è‡º") || text.includes(key + "å°")) {
                        tais = numMap[key];
                        break;
                    }
                }
            }

            if (tais === null) {
                alert("ç„¡æ³•å¾èªéŸ³ä¸­è¾¨è­˜ã€å°æ•¸ã€ï¼Œè«‹ç¢ºèªæœ‰èªªå‡ºæ•¸å­—ï¼ˆå¦‚ï¼šå…©å°ã€3å°ï¼‰ã€‚");
                return;
            }

            // èªéŸ³è¾¨è­˜ä¹Ÿåš´æ ¼é™åˆ¶åœ¨ã€Œæœ‰ä¸Šå ´ã€çš„ç©å®¶åå–®å…§åŒ¹é…
            const activePlayersList = players.filter(p => activePlayerIds.includes(p.id));
            const mentioned = activePlayersList.filter(p => text.includes(p.name));

            if (text.includes("è‡ªæ‘¸")) {
                if (mentioned.length >= 1) {
                    processTransaction(mentioned[0].id, "all", tais);
                } else {
                    alert("ç„¡æ³•è¾¨è­˜è‡ªæ‘¸çš„ç©å®¶æ˜¯èª°ï¼Œæˆ–è©²ç©å®¶æœªå‹¾é¸ä¸Šå ´ã€‚");
                }
            } else if (text.includes("æ”¾æ§") || text.includes("çµ¦") || text.includes("æ‰“çµ¦")) {
                if (mentioned.length >= 2) {
                    const idx1 = text.indexOf(mentioned[0].name);
                    const idx2 = text.indexOf(mentioned[1].name);
                    
                    let loser, winner;
                    if (idx1 < idx2) {
                        loser = mentioned[0];
                        winner = mentioned[1];
                    } else {
                        loser = mentioned[1];
                        winner = mentioned[0];
                    }
                    processTransaction(winner.id, loser.id, tais);
                } else {
                    alert("ç„¡æ³•åŒæ™‚è¾¨è­˜å‡ºæ”¾æ§è€…èˆ‡èƒ¡ç‰Œè€…ï¼Œæˆ–æœ‰ç©å®¶æœªå‹¾é¸ä¸Šå ´ã€‚");
                }
            } else {
                alert("ç„¡æ³•è§£ææŒ‡ä»¤å‹•ä½œï¼Œè«‹æ˜ç¢ºèªªå‡ºã€Œè‡ªæ‘¸ã€æˆ–ã€Œæ”¾æ§çµ¦ã€ã€‚");
            }
        }

        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–åŸ·è¡Œ
        updateSettings();
        renderPlayers();
        renderHistory();
    </script>
</body>
</html>
