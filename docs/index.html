<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­éº»å°‡è¨˜å¸³ç³»çµ± (UIå„ªåŒ–ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 p-4 md:p-8 max-w-2xl mx-auto">

    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-slate-800 mb-2">ğŸ€„ å°ˆæ¥­éº»å°‡è¨˜å¸³ç³»çµ±</h1>
        <p class="text-sm text-slate-500">ç›´è¦ºåŒ–æ“ä½œ / èŠå®¶è‡ªå‹•ç®— / ä¸€éµç”¢å‡ºæˆ°å ±</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <section class="bg-white rounded-xl shadow-sm p-5 border border-slate-200">
            <h2 class="text-lg font-bold mb-4 flex items-center">âš™ï¸ ç‰Œå±€è¨­å®š</h2>
            <div class="flex gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-slate-700 mb-1">åº•</label>
                    <input type="number" inputmode="numeric" pattern="[0-9]*" id="baseAmount" value="30" min="0" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500" onchange="updateSettings()">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-slate-700 mb-1">ä¸€å°</label>
                    <input type="number" inputmode="numeric" pattern="[0-9]*" id="pointAmount" value="10" min="0" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500" onchange="updateSettings()">
                </div>
            </div>
            <p class="text-xs text-slate-500 mt-2 text-center" id="settingDisplay">ç›®å‰è¨­å®šï¼š30 åº• / 10 å°</p>
        </section>

        <section class="bg-white rounded-xl shadow-sm p-5 border border-slate-200">
            <h2 class="text-lg font-bold mb-4 flex items-center">ğŸ‘¥ æ–°å¢ç©å®¶</h2>
            <div class="flex gap-2">
                <input type="text" id="newPlayerName" placeholder="è¼¸å…¥ç©å®¶å§“å..." class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500" onkeypress="handleKeyPress(event)">
                <button onclick="addPlayer()" class="bg-slate-800 text-white px-4 py-2 rounded-lg font-medium hover:bg-slate-700 transition">æ–°å¢</button>
            </div>
            <p class="text-xs text-slate-500 mt-2">è«‹æ–°å¢ç©å®¶ä¸¦åœ¨ä¸‹æ–¹å‹¾é¸ 4 ä½ä¸Šå ´</p>
        </section>
    </div>

    <section class="bg-white rounded-xl shadow-sm p-5 mb-6 border border-slate-200">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold flex items-center">ğŸ‘‘ ä¸Šå ´åå–®</h2>
            <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-md font-medium">è«‹å‹¾é¸ä¸Šå ´ç©å®¶ (æœ€å¤š4äºº)</span>
        </div>
        <div id="playersGrid" class="grid grid-cols-2 md:grid-cols-4 gap-3">
            </div>
    </section>

    <section class="bg-white rounded-xl shadow-sm p-5 mb-6 border border-slate-200">
        <h2 class="text-lg font-bold mb-4">ğŸ“ çµç®—é¢æ¿</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div class="col-span-1 md:col-span-4 mb-2 flex flex-col md:flex-row gap-4 bg-yellow-50 p-4 rounded-lg border border-yellow-300">
                <div class="flex-1">
                    <label class="block text-sm font-bold text-yellow-800 mb-1">ğŸ”¸ ç›®å‰èŠå®¶</label>
                    <select id="dealerSelect" class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 bg-white" onchange="updateDealer()" disabled></select>
                </div>
                <div class="w-full md:w-32">
                    <label class="block text-sm font-bold text-yellow-800 mb-1">é€£èŠæ¬¡æ•¸</label>
                    <input type="number" inputmode="numeric" pattern="[0-9]*" id="dealerStreak" min="0" value="0" class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" oninput="updateStreak()">
                </div>
                <div class="w-full md:w-auto flex items-end">
                    <p class="text-xs text-yellow-700 pb-2">ç‰½æ¶‰èŠå®¶æ™‚è‡ªå‹•åŠ ç®— <span id="dealerTaiHint" class="font-bold text-red-600">1</span> å°</p>
                </div>
            </div>
            
            <div class="col-span-1 md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 mb-1">è´å®¶</label>
                <select id="winnerSelect" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500 bg-slate-50" disabled></select>
            </div>
            <div class="col-span-1 md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 mb-1">è¼¸å®¶ (è‹¥è‡ªæ‘¸å‰‡ç„¡éœ€ç†æœƒæ­¤æ¬„)</label>
                <select id="loserSelect" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500 bg-slate-50" disabled></select>
            </div>
            
            <div class="col-span-1 md:col-span-4">
                <label class="block text-sm font-medium text-slate-700 mb-1">ç‰Œå‹å°æ•¸ (ä¸å«èŠå®¶å°)</label>
                <div class="flex items-center gap-2">
                    <input type="number" inputmode="numeric" pattern="[0-9]*" id="taiInput" min="0" value="1" class="w-full px-3 py-3 text-lg border rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500 text-center" oninput="calculatePreview()">
                    <span class="text-sm text-slate-600 whitespace-nowrap">å°</span>
                    <div class="ml-auto text-right whitespace-nowrap pl-4">
                        <span class="text-xs text-slate-500 block">é–’å®¶å–®ç¨çµ¦ä»˜é‡‘é¡</span>
                        <span id="previewAmount" class="text-2xl font-bold text-slate-800">40</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-3 mt-6">
            <button id="btnDiscard" onclick="recordTransaction('discard')" class="col-span-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition btn-disabled" disabled>ğŸ¯ æ”¾æ§çµç®—</button>
            <button id="btnSelfDrawn" onclick="recordTransaction('selfDrawn')" class="col-span-1 bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition btn-disabled" disabled>ğŸ”¥ è‡ªæ‘¸çµç®—</button>
            <button id="btnDraw" onclick="recordTransaction('draw')" class="col-span-1 bg-slate-600 text-white py-3 rounded-lg font-bold hover:bg-slate-700 transition btn-disabled" disabled>ğŸ¤ æµå±€ (é€£èŠ+1)</button>
        </div>
    </section>

    <section class="bg-white rounded-xl shadow-sm p-5 border border-slate-200">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold">ğŸ“œ äº¤æ˜“ç´€éŒ„</h2>
            <div class="space-x-2">
                <button onclick="copyReport()" class="text-sm bg-green-100 text-green-700 px-3 py-1.5 rounded-lg hover:bg-green-200 transition font-medium">ğŸ“‹ è¤‡è£½æˆ°å ±</button>
                <button onclick="clearHistory()" class="text-sm text-slate-400 hover:text-red-500 transition px-2">æ¸…ç©º</button>
            </div>
        </div>
        <ul id="historyLog" class="space-y-2 max-h-80 overflow-y-auto pr-2">
            <li class="text-slate-400 text-sm text-center py-4">ç›®å‰å°šç„¡ç´€éŒ„</li>
        </ul>
    </section>

    <script>
        let players = JSON.parse(localStorage.getItem('mahjong_players')) || [];
        let activePlayerIds = JSON.parse(localStorage.getItem('mahjong_active_players')) || [];
        let history = JSON.parse(localStorage.getItem('mahjong_history')) || [];
        let baseAmount = parseInt(localStorage.getItem('mahjong_base')) || 30;
        let pointAmount = parseInt(localStorage.getItem('mahjong_point')) || 10;
        let currentDealerId = localStorage.getItem('mahjong_dealer') || null;
        let dealerStreak = parseInt(localStorage.getItem('mahjong_streak')) || 0;

        document.getElementById('baseAmount').value = baseAmount;
        document.getElementById('pointAmount').value = pointAmount;
        document.getElementById('dealerStreak').value = dealerStreak;

        function saveData() {
            localStorage.setItem('mahjong_players', JSON.stringify(players));
            localStorage.setItem('mahjong_active_players', JSON.stringify(activePlayerIds));
            localStorage.setItem('mahjong_history', JSON.stringify(history));
            localStorage.setItem('mahjong_base', baseAmount);
            localStorage.setItem('mahjong_point', pointAmount);
            if(currentDealerId) localStorage.setItem('mahjong_dealer', currentDealerId);
            localStorage.setItem('mahjong_streak', dealerStreak);
        }

        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function updateSettings() {
            baseAmount = parseInt(document.getElementById('baseAmount').value) || 0;
            pointAmount = parseInt(document.getElementById('pointAmount').value) || 0;
            document.getElementById('settingDisplay').innerText = `ç›®å‰è¨­å®šï¼š${baseAmount} åº• / ${pointAmount} å°`;
            calculatePreview();
            saveData(); 
        }

        function updateStreak() {
            dealerStreak = parseInt(document.getElementById('dealerStreak').value) || 0;
            if (dealerStreak < 0) {
                dealerStreak = 0;
                document.getElementById('dealerStreak').value = 0;
            }
            document.getElementById('dealerTaiHint').innerText = 1 + (2 * dealerStreak);
            saveData();
        }

        function calculatePreview() {
            const tais = parseInt(document.getElementById('taiInput').value) || 0;
            const total = baseAmount + (pointAmount * tais);
            document.getElementById('previewAmount').innerText = total;
            return total;
        }

        function toggleActivePlayer(id) {
            if (activePlayerIds.includes(id)) {
                activePlayerIds = activePlayerIds.filter(pid => pid !== id);
                if(currentDealerId === id) {
                    currentDealerId = null; 
                    dealerStreak = 0;
                    document.getElementById('dealerStreak').value = 0;
                    updateStreak();
                }
            } else {
                if (activePlayerIds.length >= 4) {
                    alert("æœ€å¤šåªèƒ½å‹¾é¸ 4 ä½ä¸Šå ´ç©å®¶ï¼");
                    renderPlayers(); 
                    return;
                }
                activePlayerIds.push(id);
            }
            saveData();
            renderPlayers();
        }

        function updateDealer() {
            const newDealerId = document.getElementById('dealerSelect').value;
            if (currentDealerId !== newDealerId) {
                currentDealerId = newDealerId;
                if(newDealerId !== "") {
                    dealerStreak = 0;
                    document.getElementById('dealerStreak').value = 0;
                    updateStreak();
                }
            }
            saveData();
        }

        function updateUIState() {
            const isReady = activePlayerIds.length >= 2;
            const controls = ['winnerSelect', 'loserSelect', 'dealerSelect', 'dealerStreak', 'btnDiscard', 'btnSelfDrawn', 'btnDraw'];
            
            controls.forEach(id => {
                const el = document.getElementById(id);
                el.disabled = !isReady;
                if(isReady) {
                    el.classList.remove('btn-disabled', 'bg-slate-50', 'bg-white');
                } else {
                    el.classList.add('btn-disabled');
                }
            });
        }

        function renderPlayers() {
            const grid = document.getElementById('playersGrid');
            const winnerSelect = document.getElementById('winnerSelect');
            const loserSelect = document.getElementById('loserSelect');
            const dealerSelect = document.getElementById('dealerSelect');
            
            const currentWinner = winnerSelect.value;
            const currentLoser = loserSelect.value;

            grid.innerHTML = '';
            
            if (players.length === 0) {
                grid.innerHTML = '<div class="col-span-2 md:col-span-4 text-center text-slate-400 py-6 border-2 border-dashed border-slate-200 rounded-lg">å°šæœªåŠ å…¥ä»»ä½•ç©å®¶</div>';
                winnerSelect.innerHTML = '<option value="">è«‹å…ˆæ–°å¢</option>';
                loserSelect.innerHTML = '<option value="">è«‹å…ˆæ–°å¢</option>';
                dealerSelect.innerHTML = '<option value="">è«‹å…ˆæ–°å¢</option>';
            } else {
                players.forEach(p => {
                    const isActive = activePlayerIds.includes(p.id);
                    const isDealer = (currentDealerId === p.id);
                    grid.innerHTML += `
                        <div class="bg-slate-50 p-3 rounded-lg border text-center relative group transition-all ${isActive ? 'ring-2 ring-slate-800 bg-slate-200' : ''}">
                            <input type="checkbox" class="absolute top-2 left-2 w-4 h-4 cursor-pointer accent-slate-800" onchange="toggleActivePlayer('${p.id}')" ${isActive ? 'checked' : ''} title="å‹¾é¸ä¸Šå ´">
                            <button onclick="removePlayer('${p.id}')" class="absolute -top-2 -right-2 bg-red-100 text-red-600 rounded-full w-6 h-6 text-xs hidden group-hover:block hover:bg-red-200 shadow-sm z-10">âœ•</button>
                            <div class="font-bold text-slate-700 truncate mt-1" title="${p.name}">
                                ${isDealer ? 'ğŸ‘‘ ' : ''}${p.name}
                            </div>
                            <div class="text-xl font-bold mt-1 ${p.score >= 0 ? 'text-green-600' : 'text-red-600'}">${p.score}</div>
                        </div>
                    `;
                });

                const activePlayersList = players.filter(p => activePlayerIds.includes(p.id));
                
                if (activePlayersList.length === 0) {
                    winnerSelect.innerHTML = '<option value="">è«‹å‹¾é¸ä¸Šå ´ç©å®¶</option>';
                    loserSelect.innerHTML = '<option value="">è«‹å‹¾é¸ä¸Šå ´ç©å®¶</option>';
                    dealerSelect.innerHTML = '<option value="">è«‹å‹¾é¸ä¸Šå ´ç©å®¶</option>';
                } else {
                    winnerSelect.innerHTML = '';
                    loserSelect.innerHTML = '';
                    dealerSelect.innerHTML = '<option value="">ç„¡ (å°šæœªè¨­å®šèŠå®¶)</option>';
                    activePlayersList.forEach(p => {
                        winnerSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                        loserSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                        dealerSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }

                if (currentWinner && activePlayersList.find(p => p.id === currentWinner)) winnerSelect.value = currentWinner;
                if (currentLoser && activePlayersList.find(p => p.id === currentLoser)) loserSelect.value = currentLoser;
                if (currentDealerId && activePlayersList.find(p => p.id === currentDealerId)) {
                    dealerSelect.value = currentDealerId;
                } else {
                    currentDealerId = null;
                }
            }

            updateStreak(); 
            updateUIState();
        }

        function renderHistory() {
            const logUl = document.getElementById('historyLog');
            if (history.length === 0) {
                logUl.innerHTML = '<li class="text-slate-400 text-sm text-center py-4">ç›®å‰å°šç„¡ç´€éŒ„</li>';
                return;
            }
            logUl.innerHTML = history.map(h => `
                <li class="bg-slate-50 p-3 rounded-lg border text-sm text-slate-700 flex justify-between items-center group">
                    <div class="flex-1 pr-2">
                        <div class="mb-1">${h.text}</div>
                        <div class="text-xs text-slate-400">${h.time}</div>
                    </div>
                    <button onclick="deleteRecord('${h.id}')" class="text-xs text-red-500 bg-red-100 px-3 py-1.5 rounded-lg hover:bg-red-500 hover:text-white transition shrink-0 font-medium">é‚„åŸ</button>
                </li>
            `).join('');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') addPlayer();
        }

        function addPlayer() {
            const input = document.getElementById('newPlayerName');
            const name = input.value.trim();
            if (!name) return;
            if (players.find(p => p.name === name)) {
                alert("ç©å®¶åç¨±å·²å­˜åœ¨ï¼");
                return;
            }
            
            const newId = generateId();
            players.push({ id: newId, name: name, score: 0 });
            
            if (activePlayerIds.length < 4) {
                activePlayerIds.push(newId);
            }
            
            input.value = '';
            renderPlayers();
            saveData(); 
        }

        function removePlayer(id) {
            const p = players.find(x => x.id === id);
            if (p.score !== 0 && !confirm(`ç©å®¶ [${p.name}] å°šæœ‰åˆ†æ•¸ (${p.score})ï¼Œç¢ºå®šè¦ç§»é™¤å—ï¼Ÿ`)) {
                return;
            }
            players = players.filter(p => p.id !== id);
            activePlayerIds = activePlayerIds.filter(pid => pid !== id);
            if(currentDealerId === id) {
                currentDealerId = null;
                dealerStreak = 0;
            }
            renderPlayers();
            saveData(); 
        }

        // ====== çµ±åˆæŒ‰éˆ•é‚è¼¯ ======
        function recordTransaction(type) {
            if (activePlayerIds.length < 2) return alert("ä¸Šå ´äººæ•¸ä¸è¶³ï¼");
            
            if (type === 'draw') {
                if(!currentDealerId) return alert("è«‹å…ˆè¨­å®šèŠå®¶æ‰èƒ½æµå±€é€£èŠï¼");
                dealerStreak++;
                document.getElementById('dealerStreak').value = dealerStreak;
                updateStreak();
                
                const time = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                history.unshift({ 
                    id: generateId(), 
                    text: `ã€æµå±€ã€‘ç„¡äººèƒ¡ç‰Œï¼ŒèŠå®¶é€£èŠæ¬¡æ•¸ +1 (ç›®å‰é€£ ${dealerStreak})`, 
                    time: time, 
                    changes: [],
                    type: 'draw'
                });
                renderHistory();
                saveData();
                return;
            }

            const winnerId = document.getElementById('winnerSelect').value;
            const loserId = document.getElementById('loserSelect').value;
            const tais = parseInt(document.getElementById('taiInput').value);

            if (isNaN(tais) || tais < 0) return alert("ç„¡æ•ˆçš„å°æ•¸ï¼");

            const winner = players.find(p => p.id === winnerId);
            let logText = "";
            let changes = []; 
            let totalWinAmount = 0;

            if (type === 'selfDrawn') {
                const payingPlayers = players.filter(p => activePlayerIds.includes(p.id) && p.id !== winnerId);
                payingPlayers.forEach(p => {
                    let isDealerInvolved = (winnerId === currentDealerId || p.id === currentDealerId);
                    let dealerExtraTais = isDealerInvolved ? (1 + 2 * dealerStreak) : 0;
                    let finalTais = tais + dealerExtraTais;
                    let amount = baseAmount + (pointAmount * finalTais);
                    
                    p.score -= amount;
                    totalWinAmount += amount;
                    changes.push({ playerId: p.id, amount: -amount });
                });
                
                winner.score += totalWinAmount;
                changes.push({ playerId: winner.id, amount: totalWinAmount });
                
                let dealerNote = "";
                if (winnerId === currentDealerId || currentDealerId) {
                     let noteText = (winnerId === currentDealerId) ? "èŠå®¶è‡ªæ‘¸" : "èŠå®¶ä»˜è²»";
                     dealerNote = dealerStreak > 0 ? ` (å«${noteText}é€£${dealerStreak}åŠ ${1 + 2 * dealerStreak}å°)` : ` (å«${noteText}+1å°)`;
                }
                logText = `ã€è‡ªæ‘¸ã€‘${winner.name} ${tais}å°${dealerNote}ï¼Œè´å¾— ${totalWinAmount} é»`;

            } else if (type === 'discard') {
                if (winnerId === loserId) return alert("è´å®¶å’Œè¼¸å®¶ä¸èƒ½æ˜¯åŒä¸€äººï¼");
                const loser = players.find(p => p.id === loserId);
                
                let isDealerInvolved = (winnerId === currentDealerId || loserId === currentDealerId);
                let dealerExtraTais = isDealerInvolved ? (1 + 2 * dealerStreak) : 0;
                let finalTais = tais + dealerExtraTais;
                let amount = baseAmount + (pointAmount * finalTais);

                winner.score += amount;
                loser.score -= amount;
                
                changes.push({ playerId: winner.id, amount: amount });
                changes.push({ playerId: loser.id, amount: -amount });
                
                let dealerNote = isDealerInvolved ? (dealerStreak > 0 ? ` (å«èŠå®¶é€£${dealerStreak}åŠ ${1 + 2 * dealerStreak}å°)` : ` (å«èŠå®¶å°+1)`) : "";
                logText = `ã€æ”¾æ§ã€‘${loser.name} æ”¾æ§çµ¦ ${winner.name} ${tais}å°${dealerNote}ï¼Œæ”¯ä»˜ ${amount} é»`;
            }

            const time = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            history.unshift({ id: generateId(), text: logText, time: time, changes: changes, type: type });
            
            document.getElementById('taiInput').value = 1;
            calculatePreview();
            renderPlayers();
            renderHistory();
            saveData(); 
        }

        function deleteRecord(historyId) {
            const recordIndex = history.findIndex(h => h.id === historyId);
            if (recordIndex === -1) return;
            const record = history[recordIndex];

            if (record.type === 'draw') {
                 if (!confirm("ç¢ºå®šè¦å–æ¶ˆé€™æ¬¡æµå±€å—ï¼Ÿé€£èŠæ¬¡æ•¸å°‡æœƒ -1ã€‚")) return;
                 if (dealerStreak > 0) dealerStreak--;
                 document.getElementById('dealerStreak').value = dealerStreak;
                 updateStreak();
            } else {
                 if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„ä¸¦é‚„åŸåˆ†æ•¸å—ï¼Ÿ\n(é€£èŠæ¬¡æ•¸ä¸æœƒè‡ªå‹•å€’é€€ï¼Œè«‹è¦–æƒ…æ³æ‰‹å‹•èª¿æ•´)")) return;
                 record.changes.forEach(change => {
                    const player = players.find(p => p.id === change.playerId);
                    if (player) player.score -= change.amount; 
                 });
            }
            
            history.splice(recordIndex, 1);
            renderPlayers();
            renderHistory();
            saveData();
        }

        function clearHistory() {
            if (history.length === 0) return;
            if (confirm("é€™å°‡æœƒæ¸…é™¤æ‰€æœ‰æ­·å²ç´€éŒ„ä¸¦å°‡å¤§å®¶çš„åˆ†æ•¸æ­¸é›¶ï¼Œç¢ºå®šåŸ·è¡Œï¼Ÿ")) {
                players.forEach(p => p.score = 0);
                history = [];
                dealerStreak = 0;
                document.getElementById('dealerStreak').value = 0;
                updateStreak();
                renderPlayers();
                renderHistory();
                saveData(); 
            }
        }

        function copyReport() {
            if (players.length === 0) return alert("ç›®å‰æ²’æœ‰ç©å®¶ç´€éŒ„");
            const date = new Date().toLocaleDateString('zh-TW');
            let report = `ğŸ€„ éº»å°‡çµç®—æˆ°å ± (${date})\n`;
            report += `è¨­å®šï¼š${baseAmount} åº• / ${pointAmount} å°\n`;
            report += `--------------------\n`;
            
            // å°‡ç©å®¶ä»¥åˆ†æ•¸é«˜ä½æ’åº
            let sortedPlayers = [...players].sort((a, b) => b.score - a.score);
            sortedPlayers.forEach(p => {
                let sign = p.score > 0 ? '+' : '';
                report += `${p.name}: ${sign}${p.score}\n`;
            });
            report += `--------------------\nç¸½è¨ˆé©—ç®—: ${players.reduce((sum, p) => sum + p.score, 0)} (è‹¥é0å‰‡ä»£è¡¨è¨˜éŒ¯å¸³)`;

            navigator.clipboard.writeText(report).then(() => {
                alert("âœ… æˆ°å ±å·²è¤‡è£½ï¼æ‚¨å¯ä»¥ç›´æ¥è²¼ä¸Šè‡³ LINE ç¾¤çµ„ã€‚");
            }).catch(err => {
                alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•ç¢ºèªåˆ†æ•¸ã€‚");
            });
        }

        // åˆå§‹åŒ–
        updateSettings();
        renderPlayers();
        renderHistory();
    </script>
</body>
</html>
